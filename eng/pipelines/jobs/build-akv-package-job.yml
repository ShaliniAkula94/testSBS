#################################################################################
# Licensed to the .NET Foundation under one or more agreements.                 #
# The .NET Foundation licenses this file to you under the MIT license.          #
# See the LICENSE file in the project root for more information.                #
#################################################################################

parameters:
    - name: assemblyFileVersion
      type: string

    - name: buildConfiguration
      type: string

    - name: nugetPackageVersion
      type: string

    - name: mdsPackageVersion
      type: string

    - name: publishSymbols
      type: boolean

variables:
    - name: packageName
      type: string
      value: 'Microsoft.Data.SqlClient.AlwaysEncrypted.AzureKeyVaultProvider'

jobs:
    - job: buildSignedAkvPackage
      displayName: 'Build Signed AKV Package'
      pool:
          type: windows

      steps:
          - template: ../steps/script-output-environment-variables-step.yml@self

          - template: ../steps/compound-build-akv-step.yml@self
            parameters:
                assemblyFileVersion: '${{ parameters.assemblyFileVersion }}'
                buildConfiguration: '${{ parameters.buildConfiguration }}'
                mdsPackageVersion: '${{ parameters.mdsPackageVersion }}'

          - template: ../steps/roslyn-analyzers-akv-step.yml@self
            parameters:
                buildConfiguration: '${{ parameters.buildConfiguration }}'
                mdsPackageVersion: '${{ parameters.mdsPackageVersion }}'

          - template: ../steps/compound-esrp-code-signing-step.yml@self
            parameters:
                artifactType: dll

          - template: ../steps/compound-nuget-pack-step.yml@self
            parameters:
                buildConfiguration: '${{ parameters.buildConfiguration }}'
                generateSymbolsPackage: true    # Always generate symbols, even if they are not published
                packageVersion: '${{ parameters.nugetPackageVersion }}'
                nuspecPath: '$(REPO_ROOT)/tools/specs/add-ons/${{ variables.packageName }}.nuspec'
                outputDirectory: $(ARTIFACT_PATH)
                referenceType: 'package'

          - template: ../steps/compound-esrp-code-signing-step.yml@self
            parameters:
                artifactType: pkg

          - template: ../steps/compound-publish-akv-symbols-step.yml@self
            condition: ${{ parameters.publishSymbols }}
            parameters:
                referenceType: 'package'
                searchPattern: |
                    Windows_NT/${{ parameters.buildConfiguration }}.AnyCPU/AzureKeyVaultProvider/**/${{ variables.packageName }}.pdb
                    AnyOS/${{ parameters.buildConfiguration }}.AnyCPU/AzureKeyVaultProvider/**/${{ variables.packageName }}.pdb
                symbolsArtifactName: 'akv_symbols_$(System.TeamProject)_$(Build.Repository.Name)_$(Build.SourceBranchName)_${{ parameters.nugetPackageVersion }}_$(System.TimelineId)'
                symbolsProduct: '${{ variables.packageName }}'
                symbolsVersion: '${{ parameters.nugetPackageVersion }}'

