#################################################################################
# Licensed to the .NET Foundation under one or more agreements.                 #
# The .NET Foundation licenses this file to you under the MIT license.          #
# See the LICENSE file in the project root for more information.                #
#################################################################################

# For more details, see https://www.osgwiki.com/wiki/Symbols_Publishing_Pipeline_to_SymWeb_and_MSDL

parameters:
    - name: buildConfiguration
      type: string

    - name: buildVersion
      type: string

    - name: referenceType
      type: string
      values:
          - project
          - package

variables:
    - template: '../variables/symbol-publishing-variables.yml'

    - name: symbolsArtifactName
      type: string
      value: 'akv_symbols_$(System.TeamProject)_$(Build.Repository.Name)_$(Build.SourceBranchName)_${{ parameters.buildVersion }}_$(System.TimelineId)'

    - # Allegedly needed for downstream tasks
      name: ArtifactServices.Symbol.AccountName
      type: string
      value: '${{ variables.SymbolAccount }}'

steps:
    - task: PublishSymbols@2
      displayName: 'Upload symbols to ${{ variables.SymbolAccount }} org'
      inputs:
          IndexSources: false
          Pat: $(System.AccessToken) # @TODO: Where does this come from??
          SearchPattern: |
              Windows_NT/${{ parameters.buildConfiguration }}.AnyCPU/AzureKeyVaultProvider/**/Microsoft.Data.SqlClient.AlwaysEncrypted.AzureKeyVaultProvider.pdb
              AnyOS/${{ parameters.buildConfiguration }}.AnyCPU/AzureKeyVaultProvider/**/Microsoft.Data.SqlClient.AlwaysEncrypted.AzureKeyVaultProvider.pdb
          SymbolExpirationInDays: 1825 # 5 years
          SymbolServerType: TeamServices
          SymbolsArtifactName: ${{ variables.symbolsArtifactName }}
          SymbolsFolder: '$(ARTIFACT_PATH)/${{ parameters.referenceType }}/bin'
          SymbolsMaximumWaitTime: 60
          SymbolsProduct: 'Microsoft.Data.SqlClient.AlwaysEncrypted.AzureKeyVaultProvider'
          SymbolsVersion: ${{ parameters.buildVersion }}

    - template: './azure-cli-publish-symbols-step.yml@self'
      parameters:
          azureSubscription: "${{ variables.AzureSubscription }}"
          projectName: "${{ variables.ProjectName }}"
          publishToInternal: true
          publishToPublic: true
          symbolServer: "${{ variables.SymbolServer }}"
          symbolTokenUri: "${{ variables.SymbolTokenUri }}"
          symbolsArtifactName: "${{ variables.SymbolsArtifactName }}"


