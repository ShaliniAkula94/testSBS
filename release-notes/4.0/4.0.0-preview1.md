# Release Notes

## Microsoft.Data.SqlClient 4.0.0-preview1 released 20 August 2021

This update brings the below changes over the previous release:


### Breaking Changes over stable release v3.0
- Connection property `Asynchronous Processing` is obsolete in NetFx and has been removed.
[#1148](https://github.com/dotnet/SqlClient/pull/1148)
- The default value for connection Property `Encrypt` is set to true.
[#1210](https://github.com/dotnet/SqlClient/pull/1210)[Read more](#Encrypt-default-value-set-to-true)
- Async thread blocking on `SqlConnection open` is throwing `SqlException` instead of `AggregateException`.
[#1213](https://github.com/dotnet/SqlClient/pull/1213)

### Added
- Added [MSSQLSERVER_42109](https://docs.microsoft.com/en-us/sql/relational-databases/errors-events/mssqlserver-42109-database-engine-error?view=sql-server-ver15) and [MSSQLSERVER_42108](https://docs.microsoft.com/en-us/sql/relational-databases/errors-events/mssqlserver-42108-database-engine-error?view=sql-server-ver15) to retriable transient error list.
[#1215](https://github.com/dotnet/SqlClient/pull/1215)
- `PoolBlockingPeriod` is enabled for .NET Standard.
[#1181](https://github.com/dotnet/SqlClient/pull/1181)[Read more](#pool-blocking-period-netstandard)
- `SqlDataReader.GetColumnSchema()` API is now exposed in .NET Standard.
[#1181](https://github.com/dotnet/SqlClient/pull/1181)
- Added `EventSource` tracing support in AKV Provider.
[#1174](https://github.com/dotnet/SqlClient/pull/1174)[Read more](#eventsource-support-in-akv-provider)
- Added Activity tracking ability with `System.Diagnostics.Trace.CorrelationManager.ActivityId`.
[#1174](https://github.com/dotnet/SqlClient/pull/1174)[Read more](#activity-tracking)
- Added new App Context Switch `UseManagedNetworkingOnWindows` to go back to Operating System's supported protocols.
[#1168](https://github.com/dotnet/SqlClient/pull/1168)[Read more](#app-context-switch)
- Added missing component model annotations to `SqlConnectionStringBuilder`, `SqlConnection`, `SqlCommand`, `SqlParameter` and `SqlDataAdapter`
[#1152](https://github.com/dotnet/SqlClient/pull/1152)
- The new public API `DisableOutputParameters` is added to `SqlCommand`.
[#1041](https://github.com/dotnet/SqlClient/pull/1041)[Read more](#disable-output-parameters)

### Fixed
- Fixed async thread blocking on SqlConnection open for AAD modes.
[#1213](https://github.com/dotnet/SqlClient/pull/1213)
- Fixed bug with LegacyRowVersionNullBehavior.
[#1182](https://github.com/dotnet/SqlClient/pull/1182)
- Fixed connection issue when TLS 1.3 is enabled on operating system by excluding TLS 1.3 from supported protocols. Default Operating System could be used by App Context Switch `UseSystemDefaultSecureProtocols`.
[#1168](https://github.com/dotnet/SqlClient/pull/1168)[Read more](#app-context-switch)
- Fixed typo in Strings.resx in NetFx and NetCore
[#1178](https://github.com/dotnet/SqlClient/pull/1178/files) and [#1136](https://github.com/dotnet/SqlClient/pull/1136)
- Fixed [CI error](https://github.com/dotnet/SqlClient/pull/1041/checks?check_run_id=2889045989) by changing Strings.resx parameter `Sql_CanotCreateNormalizer` to `Sql_CannotCreateNormalizer1`.
[#1134](https://github.com/dotnet/SqlClient/pull/1134)
- Fixed the issue with cached status of an async operation by resetting the status to be ready for next operation.
[#1128](https://github.com/dotnet/SqlClient/pull/1128)
- Fixed the poor performance issue with `ExecuteNonQuery` and many parameters.
[#1041](https://github.com/dotnet/SqlClient/pull/1041)[Read more](#disable-output-parameters)

### Changes
- Changed `WeakReference` to `WeakReference<T>`.
[#1141](https://github.com/dotnet/SqlClient/pull/1141)
- Removed Designer attribute from `SqlCommand` and `SqlDataAdapter`
[#1132](https://github.com/dotnet/SqlClient/pull/1132)
- Changed error code when certificate validation fails in Managed SNI.
[#1130](https://github.com/dotnet/SqlClient/pull/1130)[Read more](#certificate-error-code-validation)
- Changed Configuarable retry logic error list.
[#1125](https://github.com/dotnet/SqlClient/pull/1125)
- Changed async thread blocking on SqlConnection open for AAD modes to throw `SqlException` instead of `AggregateException`.
[#1213](https://github.com/dotnet/SqlClient/pull/1213)
- Changed `SqlDataRecord` to remove `EnsureSubclassOverride` and ensure that all callsites with an ordinal parameter directly or indirectly call `ThrowIfInvalidOrdinal`.
[#1133](https://github.com/dotnet/SqlClient/pull/1133)
- Removed unused internal constructor and changed most of fields to readonly in `SqlDataRecord`.
[#1133](https://github.com/dotnet/SqlClient/pull/1133)
- EventSource tracing is simplified by implementing `using` block instead of `try/finally` block.
[#1187](https://github.com/dotnet/SqlClient/pull/1187) and [#1188](https://github.com/dotnet/SqlClient/pull/1188)
- The new public API `DisableOutputParameters` is added to `SqlCommand`.
[#1041](https://github.com/dotnet/SqlClient/pull/1041)[Read more](#disable-output-parameters)

## New features over stable release v3.0

### Encrypt default value set to true

Security has been encouraging us for years to change the default behavior of client drivers to be secure by default and we have resisted, knowing that it is a breaking change for most users. It's easy enough for developers to add `Encrypt = false` to all their connection strings if they need to. We just want to make sure they understand the choice they are making and they are making it deliberately. With cloud computing becoming more and more common, it's not safe to leave the default value of `Encrypt` equal to false.
The less-breaking, but still important, fix here is to ensure connections fail if the client does not have any encryption libraries available and either Encrypt = true or the server requires encryption. SqlClient + native SNI is the only Microsoft driver we have found that will successfully connect in that scenario.

### Pool Blocking Period NetStandard

The API `SqlDataReader.GetColumnSchema()` is now exposed in .NET Standard DLLs.
Aslo `Pool Blocking Period` has no API limitations in .NET Standard 2.0 and 2.1 and it has been added to .NetStandard.

### EventSource support in AKV provider

`EventSource` tracing support is introduced in AKV provider.
The EventSource traces is registered by the name of `Microsoft.Data.SqlClient.AlwaysEncrypted.AzureKeyVaultProvider.EventSource`.

### Activity tracking

Activity tracking is enabled with `System.Diagnostics.Trace.CorrelationManager.ActivityId`.

### App Context Switch

TLS 1.3 is not supported by the driver; therefore it has been removed from the supported protocols list by default. A user can go back to Operating System's default protocols by using the newly added App Context switch as below:

 `AppContext.SetSwitch("Switch.Microsoft.Data.SqlClient.UseSystemDefaultSecureProtocols", true);`

### Certificate error code validation

In order to keep error number in managed SNI and native SNI, the managed SNI errors are updated to have a` SqlException.Number` as 0.

### Disable Output Parameters

The new API takes two Boolean values of `true` or `false`.
When set to true parameters names will not be sent to the SQL server when the command is executed. This behavior has been shown to increase performance for commands with very large numbers of parameters which are used in bulk operations.

## Target Platform Support

- .NET Framework 4.6.1+ (Windows x86, Windows x64)
- .NET Core 2.1+ (Windows x86, Windows x64, Windows ARM64, Windows ARM, Linux, macOS)
- .NET Standard 2.0+ (Windows x86, Windows x64, Windows ARM64, Windows ARM, Linux, macOS)

### Dependencies

#### .NET Framework

- Microsoft.Data.SqlClient.SNI 4.0.0-preview1.21232.1
- Azure.Identity 1.3.0
- Microsoft.Identity.Client 4.22.0
- Microsoft.IdentityModel.Protocols.OpenIdConnect 6.8.0
- Microsoft.IdentityModel.JsonWebTokens 6.8.0
- System.Configuration.ConfigurationManager 5.0.0
- System.Text.Encodings.Web 4.7.2
- System.Runtime.InteropServices.RuntimeInformation 4.3.0

#### .NET Core

- Microsoft.Data.SqlClient.SNI.runtime 4.0.0-preview1.21232.1
- Microsoft.Win32.Registry 5.0.0
- System.Security.Principal.Windows 5.0.0
- System.Text.Encoding.CodePages 5.0.0
- System.Text.Encodings.Web 4.7.2
- System.Diagnostics.DiagnosticSource 5.0.0
- System.Configuration.ConfigurationManager 5.0.0
- System.Runtime.Caching 5.0.0
- Azure.Identity 1.3.0
- Microsoft.Identity.Client 4.22.0
- Microsoft.IdentityModel.Protocols.OpenIdConnect 6.8.0
- Microsoft.IdentityModel.JsonWebTokens 6.8.0

#### .NET Standard

- Microsoft.Data.SqlClient.SNI.runtime 4.0.0-preview1.21232.1
- Microsoft.Win32.Registry 5.0.0
- System.Buffers 4.5.1
- System.Memory 4.5.4
- System.Security.Principal.Windows 5.0.0
- System.Text.Encoding.CodePages 5.0.0
- System.Text.Encodings.Web 4.7.2
- System.Runtime.Caching 5.0.0
- Azure.Identity 1.3.0
- Microsoft.Identity.Client 4.22.0
- Microsoft.IdentityModel.Protocols.OpenIdConnect 6.8.0
- Microsoft.IdentityModel.JsonWebTokens 6.8.0
- System.Configuration.ConfigurationManager 5.0.0
- System.Runtime.Loader 4.3.0
